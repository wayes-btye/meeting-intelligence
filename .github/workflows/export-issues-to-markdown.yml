name: Export Issues to Markdown

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH2MD_TOKEN }}

      - name: Install gh2md
        run: |
          pip3 install --user --upgrade gh2md

      - name: Export issues & PRs to .issues directory
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.GH2MD_TOKEN }}
        run: |
          # WORKAROUND: gh2md --idempotent is broken (see gh2md issue #43)
          # Clear and recreate directory to avoid "already exists" error
          rm -rf .issues
          mkdir -p .issues

          # Export all issues + PRs, one file per item, as .md
          $HOME/.local/bin/gh2md \
            "$GITHUB_REPOSITORY" \
            .issues \
            --multiple-files \
            --file-extension .md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add .issues

          if git diff --staged --quiet; then
            echo "No changes to commit";
            exit 0;
          fi

          git commit -m "chore: update .issues export from gh2md"

      - name: Push changes
        run: git push
