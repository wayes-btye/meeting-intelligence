# [\#27 PR](https://github.com/wayes-btye/meeting-intelligence/pull/27) `merged`: fix: settings, API keys, UI field names â€” core flow now working

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) opened issue at [2026-02-19 00:48](https://github.com/wayes-btye/meeting-intelligence/pull/27):

## Summary

This PR fixes the issues discovered during manual end-to-end testing. Before this PR,
**no API endpoint that touched Supabase or external APIs actually worked** when running
locally with a `.env` file.

### Root cause

All SDK clients (`Supabase`, `Anthropic`, `OpenAI`) were constructed using `os.getenv()`
or with no arguments (relying on env vars). On Windows, `.env` files are NOT loaded into
`os.environ` automatically â€” the Pydantic `Settings` object handles this, but the code
wasn't using it consistently.

### Fixes

**Commit 1: Supabase client**
- `src/ingestion/storage.py` â€” replaced `os.getenv("SUPABASE_URL")` with `settings.supabase_url`
- This was causing 500 errors on every endpoint that touches the database (upload, query, meetings list)

**Commit 2: Anthropic and OpenAI clients**
- `src/retrieval/generation.py` â€” `Anthropic(api_key=settings.anthropic_api_key)` instead of `Anthropic()`
- `src/retrieval/search.py` â€” `OpenAI(api_key=settings.openai_api_key)` instead of `OpenAI()`
- `src/ingestion/embeddings.py` â€” same fix for the embeddings client
- Verified no remaining bare `Anthropic()` or `OpenAI()` calls exist anywhere in `src/`

**Commit 3: UI field name mismatches + documentation**
- Meetings page: `date` â†’ `created_at`, `num_chunks` â†’ `chunk_count`
- Extracted items: `owner` â†’ `assignee`, `text` â†’ `content`, flat list with `item_type` filter
- Sources display: shows speaker + similarity instead of "Unknown meeting"
- Added `docs/manual-testing-guide.md`, `docs/how-it-works.md`, `docs/understanding-the-system.md`

### What was verified manually
- Upload transcript via Streamlit â†’ 200 OK, meeting + chunks stored in Supabase âœ“
- Same transcript uploaded with naive (1 chunk) and speaker_turn (8 chunks) strategies âœ“
- Query with meeting filter â†’ semantic search finds relevant chunks â†’ Claude generates answer with citations âœ“
- Meetings page now shows correct dates, chunk counts, and speaker counts âœ“

### What this PR does NOT fix (tracked separately)
- Audio upload still crashes (Issue #22)
- Evaluation runner has no entry point (Issue #23)
- Duplicate GET extract endpoint (Issue #25)
- MeetingBank data not loaded (Issue #26)

## Test plan
- [x] `pytest tests/ -x` â€” 108 passed
- [x] `ruff check src/` â€” clean
- [x] Manual: upload â†’ query â†’ answer with sources â€” full flow verified

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) commented at [2026-02-20 00:00](https://github.com/wayes-btye/meeting-intelligence/pull/27#issuecomment-3930808351):

@claude review this

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) commented at [2026-02-20 00:00](https://github.com/wayes-btye/meeting-intelligence/pull/27#issuecomment-3930809108):

@codex review this

#### <img src="https://avatars.githubusercontent.com/in/1236702?v=4" width="50">[claude](https://github.com/apps/claude) commented at [2026-02-20 00:00](https://github.com/wayes-btye/meeting-intelligence/pull/27#issuecomment-3930809360):

**Claude finished @wayes-btye's task in 2m 7s** â€”â€” [View job](https://github.com/wayes-btye/meeting-intelligence/actions/runs/22205343003)

---
### PR Review: fix/storage-settings

**Tasks:**
- [x] Gather context and understand request
- [x] Read changed source files
- [x] Analyze diff vs origin/main
- [x] Post review feedback

---

### Summary

The fixes are correct and necessary. The root cause diagnosis is accurate â€” `os.getenv()` doesn't read `.env` files on any platform unless something separately loads them first (like `python-dotenv`), whereas Pydantic `BaseSettings` with `env_file=".env"` handles this transparently. The UI field name corrections align with the actual `MeetingSummary` and `MeetingDetail` response models.

Overall: **approve with minor notes**. Nothing blocking merge, but a few things worth tracking.

---

### Issues Found

#### 1. SDK clients created on every call (minor, pre-existing pattern)

All three SDK clients are instantiated fresh on every function call:

- `src/ingestion/embeddings.py:21` â€” `OpenAI(api_key=...)` inside `embed_texts()`
- `src/retrieval/search.py:14` â€” `OpenAI(api_key=...)` inside `get_query_embedding()`
- `src/retrieval/generation.py:30` â€” `Anthropic(api_key=...)` inside `generate_answer()`

The PR correctly fixed the key sourcing, but the instantiation-per-call pattern was preserved from before. This is low overhead for now (these are cheap HTTP clients, no persistent connections), but it's worth noting. Module-level clients would be cleaner.

[Fix this â†’](https://claude.ai/code?q=In%20branch%20fix%2Fstorage-settings%2C%20move%20the%20SDK%20client%20instantiation%20to%20module-level%20in%20src%2Fingestion%2Fembeddings.py%2C%20src%2Fretrieval%2Fsearch.py%2C%20and%20src%2Fretrieval%2Fgeneration.py%20so%20clients%20are%20not%20created%20on%20every%20function%20call.%20Use%20settings.openai_api_key%20and%20settings.anthropic_api_key%20from%20src.config.&repo=wayes-btye/meeting-intelligence)

#### 2. Falsy similarity score edge case (minor)

`src/ui/app.py:152`:
```python
sim = src.get("similarity") or src.get("combined_score")
```
If `similarity` is `0.0`, this evaluates as falsy and falls back to `combined_score`. A result with similarity exactly zero (meaningless match) would display the wrong score. Should be:
```python
sim = src.get("similarity") if src.get("similarity") is not None else src.get("combined_score")
```

[Fix this â†’](https://claude.ai/code?q=In%20branch%20fix%2Fstorage-settings%2C%20fix%20src%2Fui%2Fapp.py%20line%20152%3A%20change%20%60sim%20%3D%20src.get(%22similarity%22)%20or%20src.get(%22combined_score%22)%60%20to%20use%20a%20proper%20None%20check%20so%20a%20zero%20similarity%20score%20is%20not%20treated%20as%20falsy.&repo=wayes-btye/meeting-intelligence)

#### 3. Empty string defaults for API keys (pre-existing, not introduced here)

`src/config.py:15-17`:
```python
anthropic_api_key: str = ""
openai_api_key: str = ""
```
With empty-string defaults, a missing key fails silently at client construction and only errors later at the first API call. A validator or `str | None = None` with explicit checks at startup would give clearer error messages. Not blocking for this PR since it's pre-existing.

#### 4. N+1 query in `list_meetings` (pre-existing, not introduced here)

`src/api/routes/meetings.py:22-24` does a separate `SELECT count` per meeting. With many meetings this will be slow. Pre-existing issue, tracked in #26 context.

---

### What's Correct

- **`storage.py`**: `get_supabase_client()` now uses `settings.supabase_url` and `settings.supabase_key`. Clean and minimal change.
- **`embeddings.py`, `search.py`, `generation.py`**: API key fix is correct. Consistent with config pattern used elsewhere.
- **`app.py` meetings page**: `created_at` and `chunk_count` match `MeetingSummary` model fields exactly (`src/api/models.py:47-48`).
- **`app.py` upload result**: Still uses `num_chunks` at line 104 â€” this is correct because `IngestResponse` (`src/api/models.py:71`) has `num_chunks`, not `chunk_count`. The different field names for different response types is intentional and correct.
- **Extracted items**: Flat list with `item_type` filter matches `MeetingDetail.extracted_items: list[dict]`.
- **`created_at[:10]`** (line 178): Works for ISO timestamps. Acceptable for now.

---

### Documentation (Commits 3)

Three new files added under `docs/`. Content looks useful and accurate to the architecture. Minor nit: the `CLAUDE.md` work log policy says "NEVER create new log/summary files â€” always use `docs/work_log.md`" â€” these are architecture/guide docs (not log files), so they're fine.

---
 | [Branch: fix/storage-settings](https://github.com/wayes-btye/meeting-intelligence/tree/fix/storage-settings)


-------------------------------------------------------------------------------



[Export of Github issue for [wayes-btye/meeting-intelligence](https://github.com/wayes-btye/meeting-intelligence). Generated on 2026.02.22 at 04:18:27.]
