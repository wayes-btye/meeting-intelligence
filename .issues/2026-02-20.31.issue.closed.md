# [\#31 Issue](https://github.com/wayes-btye/meeting-intelligence/issues/31) `closed`: chore: cloud deployment — Cloud Run (API) + Vercel (frontend)

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) opened issue at [2026-02-20 00:27](https://github.com/wayes-btye/meeting-intelligence/issues/31):

## Goal

Deploy the system to cloud so the assessor can run it without local setup.

## Scope

**1. API → Google Cloud Run**
- Add `cloudbuild.yaml` or GitHub Actions deploy workflow
- Inject secrets via Cloud Run env vars (same keys as `.env`)
- Health check at `/health` already exists
- Target: `docker compose up` locally stays unchanged; Cloud Run is an additional deploy target

**2. Frontend → Vercel (once React UI exists)**
- Once Issue #32 (React frontend) is done, Vercel deploy is a `vercel.json` + push
- Streamlit retained for local dev only

**3. GitHub Actions workflow**
- `deploy.yml` triggered on push to `main` (or manual dispatch)
- Builds and pushes Docker image to GCR, deploys to Cloud Run

## Acceptance Criteria

- **1.** `POST /ingest` + `POST /query` work end-to-end from a public Cloud Run URL
- **2.** All secrets injected via environment (not committed)
- **3.** README updated with live demo URL

## Dependencies

- Issue #32 (React frontend) must be done before deploying frontend to Vercel
- Issue #26 (MeetingBank data) must be done before the demo is meaningful

## Notes

User has access to both Google Cloud and Vercel. Cloud Run chosen for API because FastAPI containerises cleanly and billing is per-request. Vercel chosen for React frontend because it's zero-config for Next.js.

Related PRD items: F65, F66

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) commented at [2026-02-21 06:57](https://github.com/wayes-btye/meeting-intelligence/issues/31#issuecomment-3938316537):

## Implementation update — auto-deploy via GitHub Actions + Vercel

Original plan was manual/scripted. Actual implementation: fully automatic on every push to \`main\`.

---

### What was built

| File | Purpose |
|------|---------|
| \`.github/workflows/deploy.yml\` | Builds Docker image → Artifact Registry → deploys to Cloud Run |
| \`vercel.json\` (repo root) | Points Vercel at \`frontend/\` subdirectory |
| \`Dockerfile\` (updated) | CMD now uses \`\${PORT:-8000}\` — Cloud Run injects \`\$PORT\` at runtime |

Tested locally: \`docker build\` clean, health check passes on both default port 8000 and \`PORT=8080\` override (Cloud Run simulation).

---

### GitHub Secrets required

Go to **Settings → Secrets and variables → Actions → New repository secret** and add all of these:

**GCP / Cloud Run:**

| Secret name | Where to get it |
|-------------|----------------|
| \`GCP_PROJECT_ID\` | GCP Console → project selector (e.g. \`my-project-123456\`) |
| \`GCP_WORKLOAD_IDENTITY_PROVIDER\` | After WIF setup: \`projects/<NUMBER>/locations/global/workloadIdentityPools/<POOL>/providers/<PROVIDER>\` |
| \`GCP_SERVICE_ACCOUNT\` | e.g. \`github-actions@<project-id>.iam.gserviceaccount.com\` |

**API keys (injected into Cloud Run at deploy time):**

| Secret name | Where to get it |
|-------------|----------------|
| \`ANTHROPIC_API_KEY\` | console.anthropic.com |
| \`OPENAI_API_KEY\` | platform.openai.com |
| \`ASSEMBLYAI_API_KEY\` | assemblyai.com dashboard |
| \`SUPABASE_URL\` | Supabase → Project Settings → API → Project URL |
| \`SUPABASE_KEY\` | Supabase → Project Settings → API → \`service_role\` key |
| \`GOOGLE_API_KEY\` | aistudio.google.com/apikey |

---

### Vercel environment variable

Set this **in the Vercel dashboard** (not GitHub) — it gets baked into the Next.js build:

| Variable | Value |
|----------|-------|
| \`NEXT_PUBLIC_API_URL\` | Your Cloud Run service URL — e.g. \`https://meeting-intelligence-api-xxxx-uc.a.run.app\` |

> Set this **after** the first successful Cloud Run deploy. Vercel will need a redeploy once you add it.

---

### GCP one-time setup (before first deploy)

```bash
PROJECT_ID=your-project-id

# 1. Create Artifact Registry repo
gcloud artifacts repositories create meeting-intelligence \
  --repository-format=docker --location=us-central1

# 2. Create service account
gcloud iam service-accounts create github-actions \
  --display-name="GitHub Actions" --project=$PROJECT_ID

# 3. Grant roles
for role in roles/run.admin roles/artifactregistry.writer roles/iam.serviceAccountUser; do
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:github-actions@${PROJECT_ID}.iam.gserviceaccount.com" \
    --role="$role"
done

# 4. Workload Identity Federation
# Full guide: https://github.com/google-github-actions/auth#setting-up-workload-identity-federation
```

---

### Deploy flow once secrets are set

1. Push to \`main\` → GitHub Actions \`deploy.yml\` triggers automatically
2. Builds image tagged \`$GITHUB_SHA\` → pushes to Artifact Registry
3. Deploys to Cloud Run service \`meeting-intelligence-api\` in \`us-central1\`
4. Vercel detects push → builds \`frontend/\` → deploys (uses \`NEXT_PUBLIC_API_URL\` you set in dashboard)

No manual steps after initial setup.

---

### CORS

Already handled — \`src/api/main.py\` has \`allow_origin_regex: r"https://.*\.vercel\.app"\` covering all Vercel preview + production URLs.

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) commented at [2026-02-21 08:13](https://github.com/wayes-btye/meeting-intelligence/issues/31#issuecomment-3938434675):

## Cloud Run Deployment — Test Results (2026-02-21)

### What was deployed
- **Service:** `meeting-intelligence-api` in `europe-west1`
- **URL:** https://meeting-intelligence-api-893899075779.europe-west1.run.app
- **Build:** Cloud Build trigger (set up via Cloud Run Console UI — no GitHub Actions needed)
- **Image:** Built from `Dockerfile` at repo root (`python:3.11-slim`, uvicorn on `$PORT`)

### Test results

| Test | Result |
|------|--------|
| `GET /health` | ✅ `{"status":"healthy"}` |
| `GET /api/meetings` | ✅ Returns all 39 meetings (MeetingBank data intact) |
| `GET /docs` | ✅ Swagger UI loads correctly |
| Auto-deploy on push to main | ✅ Cloud Build trigger fires on every push |

### What went wrong during setup (and how it was fixed)

**Problem:** After the service was live and env vars were set via the Cloud Run Console UI, the service started returning the "sad unicorn" placeholder page instead of the real app.

**Root cause:** When you edit service configuration in the Cloud Run Console UI (e.g., adding env vars), Cloud Run creates a new revision — but uses the **placeholder image** as the base for that revision, not the previously built image. Revision `00003` ended up serving 100% of traffic with the placeholder image even though revision `00002` (the real app) had been deployed correctly.

**Fix:** Re-triggered the Cloud Build trigger manually:
```bash
gcloud builds triggers run 6d002e62-7f53-4114-8bee-ac5b503f49c5 --branch main --project meeting-intelligence-488107 --region global
```
This built and deployed a new revision with the correct image + all env vars.

### Lesson learned: never edit env vars via the Cloud Run Console UI after CI/CD is set up

If you need to add or change env vars in future, use the CLI instead:
```bash
gcloud run services update meeting-intelligence-api \
  --update-env-vars KEY=VALUE \
  --region europe-west1 \
  --project meeting-intelligence-488107
```
This updates env vars without touching the image. Alternatively, just push a trivial commit to main — Cloud Build will redeploy with the correct image and the env vars you've set will be preserved.

### Also resolved: GitHub Actions Deploy workflow

PR #50 added a `deploy.yml` GitHub Actions workflow that tried to deploy via Actions (failed in 10s — no `GCP_SA_KEY` secret). PR #51 removed it and switched fully to Cloud Build. The Cloud Build trigger created via the Cloud Run UI is the correct and only deploy mechanism — no GitHub Actions needed for deployment.

### CI/CD flow going forward

```
Push to main
  → Cloud Build trigger fires (auto, set up in Cloud Run Console)
  → Builds Dockerfile
  → Pushes image to Artifact Registry
  → Deploys new revision to Cloud Run
  → 100% traffic shifted automatically
```


-------------------------------------------------------------------------------



[Export of Github issue for [wayes-btye/meeting-intelligence](https://github.com/wayes-btye/meeting-intelligence). Generated on 2026.02.22 at 04:18:27.]
