# [\#36 PR](https://github.com/wayes-btye/meeting-intelligence/pull/36) `merged`: fix: audio upload clean error + remove duplicate extract endpoint (#22, #25)

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) opened issue at [2026-02-20 07:24](https://github.com/wayes-btye/meeting-intelligence/pull/36):

## Summary

- **Issue #22** — Audio uploads (`.mp3`, `.wav`, `.m4a`, etc.) crashed with a 500 `UnicodeDecodeError` because the ingest endpoint called `raw.decode("utf-8")` on binary audio bytes before checking the file type. Fixed by detecting audio extensions first, then routing to AssemblyAI transcription.
- **Issue #25** — A duplicate `GET /api/meetings/{id}/extract` handler existed in `src/api/routes/meetings.py` (not `extraction.py` as initially suspected). It shadowed the correct `POST` handler and returned malformed responses. The GET handler is removed; only `POST /api/meetings/{id}/extract` in `extraction.py` remains.

## Audio path taken (Issue #22)

`ASSEMBLYAI_API_KEY` is set in `.env`, so the **AssemblyAI transcription path was implemented** (not the 501 fallback). The flow:

**1.** Audio file extension detected (`mp3`, `wav`, `m4a`, `mp4`, `ogg`, `flac`)
**2.** Audio bytes written to a temp file
**3.** `assemblyai.Transcriber().transcribe(path)` called synchronously
**4.** On transcription error: `400 Bad Request` (not 500)
**5.** On success: transcript text continues through the existing chunking/embedding pipeline

If `ASSEMBLYAI_API_KEY` is empty/missing, returns `501 Not Implemented` with message: `"Audio transcription is not configured. Please upload a text transcript (.vtt, .txt, .json)."`

Known limitation (noted in code comment): `_transcribe_audio` is synchronous/blocking — it polls AssemblyAI until transcription is complete. This blocks the async event loop on the `/ingest` call. A proper fix would wrap with `asyncio.to_thread()`. Acceptable for current single-user usage.

## Files changed

| File | Change |
|------|--------|
| `src/api/routes/ingest.py` | Add `AUDIO_EXTENSIONS` set, `_transcribe_audio()` helper, audio branch before UTF-8 decode |
| `src/api/routes/meetings.py` | Remove duplicate `GET /api/meetings/{meeting_id}/extract` handler + unused `ExtractResponse` import |
| `tests/test_api.py` | Add `test_audio_upload_returns_clean_response_not_500` and `test_extract_endpoint_no_get_method` |

## TDD

Tests were written first (red), then fixes applied (green).

- `test_audio_upload_returns_clean_response_not_500`: fake MP3 binary header (`\xff\xfb\x90\x00`) makes a real AssemblyAI call, which rejects the fake audio and returns `400` (not `500`) ✅
- `test_extract_endpoint_no_get_method`: `GET /api/meetings/some-fake-id/extract` returns `405 Method Not Allowed` ✅

Note: `test_audio_upload_returns_clean_response_not_500` makes a live AssemblyAI API call (fast — fake audio is rejected quickly). Not marked `@pytest.mark.expensive` per the TDD spec in the worktree doc.

## Manual verification needed

**Audio transcription with real audio:**

**1.** Start API: `make api`
**2.** Upload a real `.mp3` or `.wav` file:

```bash
curl -X POST http://localhost:8000/api/ingest \
  -F "file=@path/to/your/audio.mp3" \
  -F "title=My Audio Meeting"
```

**3.** Verify response is `200` with `meeting_id`, `num_chunks > 0`
**4.** Verify meeting appears in `GET /api/meetings` with transcript text content

## Band-aid fix assessment

| Fix | Proper or band-aid? | Notes |
|-----|---------------------|-------|
| Audio extension check before decode | **Proper** | Correct place to gate the audio path |
| `_transcribe_audio` sync/blocking in async handler | **Band-aid** | Blocks event loop; proper fix is `asyncio.to_thread(_transcribe_audio, raw, ext)` — deferred to avoid scope creep |
| Remove GET handler from meetings.py | **Proper** | Duplicate was simply deleted; no logic changed |

Closes #22, Closes #25

#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) commented at [2026-02-20 07:31](https://github.com/wayes-btye/meeting-intelligence/pull/36#issuecomment-3932171054):

@claude review

#### <img src="https://avatars.githubusercontent.com/in/1236702?v=4" width="50">[claude](https://github.com/apps/claude) commented at [2026-02-20 07:31](https://github.com/wayes-btye/meeting-intelligence/pull/36#issuecomment-3932171862):

**Claude finished @wayes-btye's task in 2m 2s** —— [View job](https://github.com/wayes-btye/meeting-intelligence/actions/runs/22215451918)

---
### PR Review — fix/22-25-audio-endpoint <img src="https://github.com/user-attachments/assets/5ac382c7-e004-429b-8e35-7feb3e8f9c6f" width="14px" height="14px" style="vertical-align: middle; margin-left: 4px;" />

- [x] Gather context from PR description and existing review comments
- [x] Read changed files: `ingest.py`, `meetings.py`, `test_api.py`, `conftest.py`, `extraction.py`
- [x] Analyze code quality, correctness, error handling, tests
- [x] Post comprehensive review

---

### Overall Assessment

The core fixes are correct: the UTF-8 decode crash is properly gated behind the extension check, and the duplicate GET handler is cleanly removed. The PR is honest about the known band-aid (blocking event loop). Two issues from the Codex review are confirmed real and worth addressing before merge.

---

### `src/api/routes/ingest.py`

**[Confirmed] Blanket `except Exception → 400` misclassifies server errors** (`ingest.py:54–58`)

```python
except Exception as exc:
    raise HTTPException(status_code=400, detail=f"Transcription failed: {exc}") from exc
```

The `aai.TranscriptStatus.error` branch (line 46–50) correctly returns 400 for content failures. But the outer `except Exception` catches *everything* — auth failures (`invalid API key`), network timeouts, SDK internal errors — and also returns 400. That's wrong: it makes provider outages look like bad client uploads.

The fix: catch SDK-specific transcript errors as 400, let everything else propagate as 500 (or 503).

[Fix this →](https://claude.ai/code?q=In%20src%2Fapi%2Froutes%2Fingest.py%20on%20branch%20fix%2F22-25-audio-endpoint%2C%20the%20%60except%20Exception%60%20block%20at%20line%2054%20raises%20HTTP%20400%20for%20all%20errors%20including%20auth%20failures%2C%20timeouts%2C%20and%20provider%20outages.%20Fix%20it%20to%20only%20return%20400%20for%20transcript-content%20errors%20(assemblyai%20TranscriptStatus.error)%20and%20re-raise%20or%20return%20503%20for%20infrastructure%20errors.&repo=wayes-btye%2Fmeeting-intelligence)

---

**Temp file leak on write failure** (`ingest.py:40–60`)

```python
with tempfile.NamedTemporaryFile(suffix=f".{ext}", delete=False) as tmp:
    tmp.write(raw)       # ← if this raises, tmp_path is never assigned
    tmp_path = tmp.name  #

try:
    ...
finally:
    os.unlink(tmp_path)  # ← NameError if write failed, file stays on disk
```

If `tmp.write(raw)` raises (e.g. disk full), `tmp_path` is undefined and the `finally` block raises `NameError`, masking the original exception and leaving the temp file on disk. Assign `tmp_path = None` before the `with` block and guard the unlink.

[Fix this →](https://claude.ai/code?q=In%20src%2Fapi%2Froutes%2Fingest.py%20on%20branch%20fix%2F22-25-audio-endpoint%2C%20the%20%60_transcribe_audio%60%20function%20can%20leak%20a%20temp%20file%20if%20%60tmp.write(raw)%60%20raises%20before%20%60tmp_path%60%20is%20assigned.%20Assign%20%60tmp_path%20%3D%20None%60%20before%20the%20with%20block%20and%20guard%20the%20unlink%20with%20%60if%20tmp_path%20is%20not%20None%60.&repo=wayes-btye%2Fmeeting-intelligence)

---

**Minor: no-extension filename falls through to binary UTF-8 decode** (`ingest.py:87`)

If a file has no `.` in its name, `"myfile".rsplit(".", 1)[-1]` returns `"myfile"` (not in `AUDIO_EXTENSIONS`), which proceeds to `raw.decode("utf-8")` — restoring the original crash for binary-but-extensionless uploads. Low probability but worth noting. The content-type header is a reasonable fallback.

---

**Known band-aid — acknowledged** (`ingest.py:99–102`)

`_transcribe_audio` blocks the async event loop. The PR description and code comment both acknowledge this and scope it to single-user usage. It should have a tracking issue so it doesn't get forgotten. The proper fix is `await asyncio.to_thread(_transcribe_audio, raw, ext)`.

---

### `src/api/routes/meetings.py`

Clean removal of the duplicate handler. The explanatory comment on line 86–87 is appropriate. No issues.

---

### `tests/test_api.py`

**[Confirmed] Live network call in CI test** (`test_api.py:43–57`)

The test title says `# no external API keys required` (line 1), but this test makes a real AssemblyAI HTTP call when `ASSEMBLYAI_API_KEY` is present. Two failure modes:

- **Key missing**: test exercises only the 501 path — it passes but doesn't validate the 400-not-500 regression
- **Key present**: real network call on every `make test` run; flaky if AssemblyAI is unavailable

The regression can be validated deterministically by patching `_transcribe_audio` to raise a known exception, or by testing the 501 path explicitly (no key needed). If the live call is kept, it must be `@pytest.mark.expensive` per project convention.

[Fix this →](https://claude.ai/code?q=In%20tests%2Ftest_api.py%20on%20branch%20fix%2F22-25-audio-endpoint%2C%20%60test_audio_upload_returns_clean_response_not_500%60%20makes%20a%20live%20AssemblyAI%20call.%20Mock%20%60src.api.routes.ingest._transcribe_audio%60%20to%20raise%20an%20HTTPException(400)%20so%20the%20test%20is%20deterministic%20and%20doesn%27t%20require%20a%20real%20API%20key%2C%20or%20add%20%40pytest.mark.expensive%20and%20document%20the%20dependency.&repo=wayes-btye%2Fmeeting-intelligence)

---

**Inconsistent fixture vs. module-level client** (`test_api.py:7` vs. `43,61`)

The file defines `client = TestClient(app)` at module level (line 7), and all existing tests use it directly. The two new tests take `client` as a parameter (resolved via the `conftest.py` fixture). This works but creates two patterns in one file. Recommend either using the module-level global or converting all tests to the fixture pattern.

---

### Summary

| Area | Finding | Severity |
|------|---------|----------|
| `ingest.py:54–58` | All AssemblyAI failures → 400 (confirmed Codex P2) | Medium — fix before merge |
| `ingest.py:40–60` | Temp file leak if write raises | Low — minor resource hygiene |
| `tests/test_api.py:43–57` | Live API call in non-expensive test (confirmed Codex P2) | Medium — fix before merge or mark `@pytest.mark.expensive` |
| `tests/test_api.py:7 vs 43,61` | Two client patterns in one file | Low — cosmetic inconsistency |
| `ingest.py:99–102` | Blocking event loop (acknowledged band-aid) | Track in a follow-up issue |
| `meetings.py` | Clean fix, no issues | ✅ |

The two medium findings (5xx/4xx semantic misclassification and live test call) should be addressed before merge. The rest can be follow-up issues.


-------------------------------------------------------------------------------



[Export of Github issue for [wayes-btye/meeting-intelligence](https://github.com/wayes-btye/meeting-intelligence). Generated on 2026.02.21 at 04:07:53.]
