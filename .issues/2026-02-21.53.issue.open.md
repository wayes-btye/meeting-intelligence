# [\#53 Issue](https://github.com/wayes-btye/meeting-intelligence/issues/53) `open`: feat: API key header protection on Cloud Run (harden public endpoint)
**Labels**: `enhancement`, `infrastructure`, `post-mvp`


#### <img src="https://avatars.githubusercontent.com/u/151667361?v=4" width="50">[wayes-btye](https://github.com/wayes-btye) opened issue at [2026-02-21 08:29](https://github.com/wayes-btye/meeting-intelligence/issues/53):

## Problem

The Cloud Run API is publicly accessible to anyone with the URL. While the URL is not indexed or guessable, there is no protection against:
- Token burn attacks (spamming `/api/query` or `/api/ingest` to consume OpenAI/Anthropic credits)
- Bulk data extraction (`GET /api/meetings`)
- Storage abuse (uploading junk via `/api/ingest`)

## Solution: X-API-Key header middleware

Add a simple secret header check as FastAPI middleware. All requests must include `X-API-Key: <secret>` or they receive a 401. The frontend sends this header automatically on every request.

### Backend — `src/api/main.py`

\`\`\`python
from fastapi.responses import JSONResponse

@app.middleware("http")
async def verify_api_key(request: Request, call_next: Any) -> Any:
    # Health check stays open (Cloud Run readiness probe)
    if request.url.path == "/health":
        return await call_next(request)
    # All other routes require the API key header
    if settings.api_key and request.headers.get("X-API-Key") != settings.api_key:
        return JSONResponse({"detail": "Unauthorized"}, status_code=401)
    return await call_next(request)
\`\`\`

Add to `src/config.py` Settings:
\`\`\`python
api_key: str | None = None  # optional — if not set, middleware is skipped (dev mode)
\`\`\`

### Frontend — `frontend/lib/api.ts`

Add header to every fetch call:
\`\`\`typescript
const headers: HeadersInit = {
  'Content-Type': 'application/json',
  ...(process.env.NEXT_PUBLIC_API_KEY ? { 'X-API-Key': process.env.NEXT_PUBLIC_API_KEY } : {}),
}
\`\`\`

### Environment variables

| Where | Key | Value |
|-------|-----|-------|
| Cloud Run | `API_KEY` | A strong random secret (generate with `openssl rand -hex 32`) |
| Vercel | `NEXT_PUBLIC_API_KEY` | Same secret |

### Graceful dev mode

If `API_KEY` is not set in the environment, the middleware passes all requests through. This means local development works without any config change.

## Note on auth vs API key protection

This issue is about **backend hardening** — protecting the API from abuse even if someone finds the URL directly. It is separate from the frontend login (issue #50) which protects the UI. Together they provide:
- Frontend: only logged-in users can use the app
- Backend: even direct API calls require the shared secret

## Test plan
- [ ] `GET /health` returns 200 without any header (Cloud Run probe must work)
- [ ] `GET /api/meetings` without header returns 401
- [`GET /api/meetings` with correct `X-API-Key` header returns 200
- [ ] Frontend works end-to-end with the header injected
- [ ] Local dev without `API_KEY` set works normally
- [ ] All existing tests pass (mock middleware or set API_KEY=test in test config)

## Effort
Small — ~15 lines backend + header threading in `api.ts`. No DB changes.

**Do after assessment** — frontend auth (issue above) is sufficient for the demo.




-------------------------------------------------------------------------------



[Export of Github issue for [wayes-btye/meeting-intelligence](https://github.com/wayes-btye/meeting-intelligence). Generated on 2026.02.27 at 04:14:01.]
